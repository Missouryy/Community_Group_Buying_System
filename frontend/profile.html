<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ä¸ªäººèµ„æ–™ - ç¤¾åŒºå›¢è´­</title>
    <!-- æ€§èƒ½ä¼˜åŒ–ï¼šé¢„è¿æ¥CDN -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <!-- å…³é”®CSSï¼šé˜²æ­¢emojié—ªçƒ -->
    <style>
        body,*{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji",sans-serif!important}
    </style>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/apple-theme.css" rel="stylesheet">
    <link href="/styles.css" rel="stylesheet">
</head>
<body>
    <!-- å¯¼èˆªå°†ç”± nav.js åŠ¨æ€ç”Ÿæˆ -->

    <div class="container py-3">
            <main>
                <div id="page-profile" class="page">
                    <div class="row g-4">
                        <!-- å·¦ä¾§æ  -->
                        <div class="col-12 col-lg-5">
                            <!-- ä¼šå‘˜ä¸­å¿ƒå¡ç‰‡ -->
                            <div class="card shadow-community lift mb-4">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="fs-1 me-3">ğŸ‘¤</div>
                                        <div>
                                            <h5 class="card-title mb-1">ä¼šå‘˜ä¸­å¿ƒ</h5>
                                            <div class="text-muted small">äº«å—ä¸“å±ä¼˜æƒ å’Œæƒç›Š</div>
                                        </div>
                                    </div>
                                    
                                    <!-- ç®¡ç†å‘˜ä¿¡æ¯åŒºåŸŸï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰ -->
                                    <div id="admin-info-area" style="display:none" class="mb-3">
                                        <div class="d-flex align-items-center justify-content-between p-3 rounded" style="background: linear-gradient(135deg, rgba(255, 42, 0, 0.08) 0%, rgba(255, 42, 0, 0.05) 100%); border: 1.5px solid rgba(255, 42, 0, 0.2);">
                                            <div class="d-flex align-items-center">
                                                <div style="font-size: 2.5rem; line-height: 1;" class="me-3">âš™ï¸</div>
                                                <div>
                                                    <div class="fw-bold fs-6 mb-1" style="color: #ff2a00;">ç³»ç»Ÿç®¡ç†å‘˜</div>
                                                    <div class="text-muted small">æ‹¥æœ‰ç³»ç»Ÿæœ€é«˜æƒé™ï¼Œç®¡ç†æ‰€æœ‰åŠŸèƒ½</div>
                                                </div>
                                            </div>
                                            <a href="/admin.html" class="btn btn-danger btn-sm">è¿›å…¥ç®¡ç†åå°</a>
                                        </div>
                                    </div>
                                    
                                    <!-- å›¢é•¿ä¿¡æ¯åŒºåŸŸï¼ˆä»…å›¢é•¿å¯è§ï¼‰ -->
                                    <div id="leader-info-area" style="display:none" class="mb-3">
                                        <div class="d-flex align-items-center justify-content-between p-3 rounded" style="background: linear-gradient(135deg, rgba(255, 149, 0, 0.08) 0%, rgba(255, 159, 10, 0.05) 100%); border: 1.5px solid rgba(255, 149, 0, 0.2);">
                                            <div class="d-flex align-items-center">
                                                <div style="font-size: 2.5rem; line-height: 1;" class="me-3">ğŸ‘‘</div>
                                                <div>
                                                    <div class="fw-bold fs-6 mb-1" style="color: #FF9500;">å·²æˆä¸ºå›¢é•¿</div>
                                                    <div class="text-muted small">æ‚¨å¯ä»¥å‘èµ·æ‹¼å•ï¼Œç®¡ç†è®¢å•ï¼Œèµšå–ä½£é‡‘</div>
                                                </div>
                                            </div>
                                            <a href="/leader.html" class="btn btn-warning btn-sm">è¿›å…¥å›¢é•¿é—¨æˆ·</a>
                                        </div>
                                    </div>
                                    
                                    <!-- ä¼šå‘˜ç­‰çº§ä¿¡æ¯ -->
                                    <div class="mb-3 p-3 rounded" style="background: rgba(0, 122, 255, 0.05); border: 1.5px solid rgba(0, 122, 255, 0.1);">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div class="d-flex align-items-center">
                                                <div id="member-tier-emoji" style="font-size: 2.5rem; line-height: 1;" class="me-3">ğŸ¥‰</div>
                                                <div>
                                                    <div id="member-tier" class="fw-bold fs-6 mb-0">Bronze</div>
                                                    <div class="text-muted small">ä¼šå‘˜ç­‰çº§</div>
                                                </div>
                                            </div>
                                            <div class="text-end">
                                                <div id="member-points" class="fw-bold text-primary" style="font-size: 2rem; line-height: 1;">0</div>
                                                <div class="text-muted small">å½“å‰ç§¯åˆ†</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <span class="small text-muted">å‡çº§è¿›åº¦</span>
                                            <span class="small text-muted">è·ç¦»ä¸‹ä¸€ç­‰çº§è¿˜éœ€ <span id="points-to-next" class="fw-semibold">0</span> åˆ†</span>
                                        </div>
                                        <div class="progress"><div id="member-progress" class="progress-bar" style="width:0%">0%</div></div>
                                    </div>
                                    
                                    <div class="row g-3 text-center">
                                        <div class="col-4">
                                            <div class="fs-6 fw-bold" id="total-orders">0</div>
                                            <div class="text-muted small">æ€»è®¢å•</div>
                                        </div>
                                        <div class="col-4">
                                            <div class="fs-6 fw-bold" id="total-savings">Â¥0</div>
                                            <div class="text-muted small">ç´¯è®¡èŠ‚çœ</div>
                                        </div>
                                        <div class="col-4">
                                            <div class="fs-6 fw-bold" id="join-days">0</div>
                                            <div class="text-muted small">åŠ å…¥å¤©æ•°</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ç”³è¯·æˆä¸ºå›¢é•¿å¡ç‰‡ï¼ˆä»…æ™®é€šç”¨æˆ·å¯è§ï¼‰ -->
                            <div id="apply-leader-card" style="display:none">
                                <div class="card shadow-deal lift" style="border: 2px solid rgba(255, 149, 0, 0.3);">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="fs-1 me-3">ğŸ‘‘</div>
                                            <div>
                                                <h5 class="card-title mb-1">æˆä¸ºç¤¾åŒºå›¢é•¿</h5>
                                                <div class="text-muted small">ç»„ç»‡æ‹¼å•ï¼ŒæœåŠ¡é‚»é‡Œï¼Œèµšå–ä½£é‡‘</div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <h6 class="fw-semibold mb-2">å›¢é•¿æƒç›Šï¼š</h6>
                                            <ul class="mb-0 ps-3">
                                                <li class="text-muted small mb-1">âœ¨ å‘èµ·æ‹¼å•ï¼Œè‡ªç”±é€‰æ‹©å•†å“å’Œæ—¶é—´</li>
                                                <li class="text-muted small mb-1">ğŸ’° æ¯ç¬”è®¢å•è·å¾—ä½£é‡‘æ”¶ç›Š</li>
                                                <li class="text-muted small mb-1">ğŸ“Š ä¸“å±å›¢é•¿ç®¡ç†åå°</li>
                                                <li class="text-muted small mb-1">ğŸ† ä¼˜å…ˆäº«å—å¹³å°æ–°åŠŸèƒ½å’Œæ´»åŠ¨</li>
                                            </ul>
                                        </div>
                                        
                                        <button class="btn btn-warning btn-lg w-100 mb-2" onclick="showLeaderApplicationForm()">
                                            ç«‹å³ç”³è¯·
                                        </button>
                                        <div class="text-muted small text-center">å®¡æ ¸æ—¶é—´ï¼š1-3ä¸ªå·¥ä½œæ—¥</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- å³ä¾§æ  - ä¸ªäººèµ„æ–™å¡ç‰‡ -->
                        <div class="col-12 col-lg-7">
                            <div class="card shadow-community lift">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="fs-1 me-3">âœï¸</div>
                                        <div>
                                            <h5 class="card-title mb-1">ä¸ªäººèµ„æ–™</h5>
                                            <div class="text-muted small">å®Œå–„èµ„æ–™ï¼Œäº«å—æ›´å¥½æœåŠ¡</div>
                                        </div>
                                    </div>
                                    
                                    <form id="profile-form" class="vstack gap-3">
                                        <div>
                                            <label class="form-label fw-semibold">å§“å</label>
                                            <input type="text" id="pf-realname" class="form-control" placeholder="è¯·è¾“å…¥çœŸå®å§“å">
                                        </div>
                                        <div>
                                            <label class="form-label fw-semibold">é‚®ç®±</label>
                                            <input type="email" id="pf-email" class="form-control" placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€">
                                        </div>
                                        <div>
                                            <label class="form-label fw-semibold">æ‰‹æœºå·</label>
                                            <input type="tel" id="pf-phone" class="form-control" placeholder="è¯·è¾“å…¥æ‰‹æœºå·ç ">
                                        </div>
                                        <div>
                                            <label class="form-label fw-semibold">æ”¶è´§åœ°å€</label>
                                            <textarea id="pf-address" class="form-control" rows="2" placeholder="è¯·è¾“å…¥è¯¦ç»†æ”¶è´§åœ°å€"></textarea>
                                        </div>
                                        
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-primary flex-fill" id="pf-save" type="button">
                                                ğŸ’¾ ä¿å­˜èµ„æ–™
                                            </button>
                                            <button class="btn btn-outline-secondary" id="pf-reset" type="button">
                                                ğŸ”„ é‡ç½®
                                            </button>
                                        </div>
                                        <div id="pf-msg" class="small" style="display:none"></div>
                                    </form>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/nav.js"></script>
    <script>
      let originalProfileData = {};
      
      async function loadProfile() {
        const tokens = window.api.getTokens();
        if (!tokens.access) { window.location.href = '/login.html'; return; }
        
        // åŠ è½½ç”¨æˆ·åŸºæœ¬ä¿¡æ¯å’Œä¼šå‘˜ä¿¡æ¯
        const [meRes, tiersRes] = await Promise.all([
          window.api.fetchAPI('/api/users/me/'),
          window.api.fetchAPI('/api/memberships/tiers/').catch(() => null)
        ]);
        
        if (!meRes.ok) return;
        const me = await meRes.json();
        originalProfileData = { ...me };
        
        // æ›´æ–°ä¼šå‘˜ä¿¡æ¯
        const tierName = me.membership_tier?.tier_name || 'Bronze';
        const points = me.loyalty_points || 0;
        
        // æ ¹æ®ä¼šå‘˜ç­‰çº§æ˜¾ç¤ºå¯¹åº”emoji
        const tierEmojis = {
          'Bronze': 'ğŸ¥‰',
          'Silver': 'ğŸ¥ˆ',
          'Gold': 'ğŸ¥‡',
          'Diamond': 'ğŸ’',
          'é’é“œä¼šå‘˜': 'ğŸ¥‰',
          'é“¶ç‰Œä¼šå‘˜': 'ğŸ¥ˆ',
          'é‡‘ç‰Œä¼šå‘˜': 'ğŸ¥‡',
          'é’»çŸ³ç”¨æˆ·': 'ğŸ’'
        };
        const tierEmoji = tierEmojis[tierName] || 'ğŸ¥‰';
        
        document.getElementById('member-tier').textContent = tierName;
        document.getElementById('member-tier-emoji').textContent = tierEmoji;
        document.getElementById('member-points').textContent = points;
        
        // è®¡ç®—å‡çº§è¿›åº¦
        if (tiersRes && tiersRes.ok) {
          const tiers = await tiersRes.json();
          const currentRequired = me.membership_tier?.points_required || 0;
          const nextTier = tiers.find(t => t.points_required > currentRequired);
          const target = nextTier ? nextTier.points_required : currentRequired || 100;
          const ratio = Math.min(100, Math.round((points / target) * 100));
          
          document.getElementById('member-progress').style.width = ratio + '%';
          document.getElementById('member-progress').textContent = ratio + '%';
          document.getElementById('points-to-next').textContent = Math.max(0, target - points);
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        document.getElementById('total-orders').textContent = me.total_orders || 0;
        document.getElementById('total-savings').textContent = `Â¥${me.total_savings || 0}`;
        const joinDays = me.date_joined ? Math.floor((new Date() - new Date(me.date_joined)) / (1000 * 60 * 60 * 24)) : 0;
        document.getElementById('join-days').textContent = joinDays;

        // å¡«å……ä¸ªäººèµ„æ–™è¡¨å•
        document.getElementById('pf-realname').value = me.real_name || '';
        document.getElementById('pf-email').value = me.email || '';
        document.getElementById('pf-phone').value = me.phone || '';
        document.getElementById('pf-address').value = me.address || '';
        
        // åŠ è½½è§’è‰²ä¿¡æ¯ï¼ˆç®¡ç†å‘˜/å›¢é•¿ï¼‰
        loadRoleInfo(me);
      }
      
      function loadRoleInfo(user) {
        const adminArea = document.getElementById('admin-info-area');
        const leaderArea = document.getElementById('leader-info-area');
        const applyLeaderCard = document.getElementById('apply-leader-card');
        
        // æ˜¾ç¤ºç®¡ç†å‘˜ä¿¡æ¯
        if (adminArea) {
          adminArea.style.display = user.role === 'admin' ? '' : 'none';
        }
        
        // æ˜¾ç¤ºå›¢é•¿ä¿¡æ¯
        if (leaderArea) {
          leaderArea.style.display = user.role === 'leader' ? '' : 'none';
        }
        
        // æ˜¾ç¤ºç”³è¯·æˆä¸ºå›¢é•¿å¡ç‰‡ï¼ˆä»…æ™®é€šç”¨æˆ·å¯è§ï¼‰
        if (applyLeaderCard) {
          const isNormalUser = user.role !== 'admin' && user.role !== 'leader';
          applyLeaderCard.style.display = isNormalUser ? '' : 'none';
        }
      }
      
      // å›¢é•¿ç”³è¯·ç›¸å…³å‡½æ•°
      function showLeaderApplicationForm() {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">ğŸ‘‘ ç”³è¯·æˆä¸ºå›¢é•¿</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="leader-application-form">
                  <div class="mb-3">
                    <label class="form-label">è”ç³»ç”µè¯ <span class="text-danger">*</span></label>
                    <input type="tel" class="form-control" id="app-phone" required>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">æ‰€åœ¨åœ°åŒº <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="app-address" placeholder="å¦‚ï¼šåŒ—äº¬å¸‚æœé˜³åŒºæŸæŸå°åŒº" required>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">ç”³è¯·ç†ç”±</label>
                    <textarea class="form-control" id="app-reason" rows="3" placeholder="è¯·ç®€å•è¯´æ˜æ‚¨ç”³è¯·æˆä¸ºå›¢é•¿çš„åŸå› å’Œä¼˜åŠ¿"></textarea>
                  </div>
                  <div class="alert alert-info">
                    <small>ğŸ“ æäº¤ç”³è¯·åï¼Œç®¡ç†å‘˜å°†åœ¨1-3ä¸ªå·¥ä½œæ—¥å†…å®Œæˆå®¡æ ¸</small>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="submitLeaderApplication()">æäº¤ç”³è¯·</button>
              </div>
            </div>
          </div>`;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        modal.addEventListener('hidden.bs.modal', () => modal.remove());
      }
      
      async function submitLeaderApplication() {
        const phone = document.getElementById('app-phone').value;
        const address = document.getElementById('app-address').value;
        const reason = document.getElementById('app-reason').value;
        
        if (!phone || !address) {
          alert('è¯·å¡«å†™å¿…è¦ä¿¡æ¯');
          return;
        }
        
        try {
          const res = await window.api.fetchAPI('/api/users/apply-leader/', {
            method: 'POST',
            body: { phone, address, reason }
          });
          
          if (res.ok) {
            alert('ç”³è¯·æäº¤æˆåŠŸï¼è¯·ç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸');
            bootstrap.Modal.getInstance(document.querySelector('.modal.show')).hide();
            loadProfile(); // é‡æ–°åŠ è½½é¡µé¢
          } else {
            alert('ç”³è¯·æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
          }
        } catch (error) {
          alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
        }
      }
      
      function reapplyLeader() {
        showLeaderApplicationForm();
      }
      
      document.addEventListener('DOMContentLoaded', () => {
        loadProfile();
        
        // ä¿å­˜ä¸ªäººèµ„æ–™
        document.getElementById('pf-save')?.addEventListener('click', async () => {
          const msg = document.getElementById('pf-msg');
          const saveBtn = document.getElementById('pf-save');
          
          msg.style.display = 'none';
          saveBtn.disabled = true;
          saveBtn.textContent = 'ä¿å­˜ä¸­...';
          
          try {
            const body = {
              real_name: document.getElementById('pf-realname').value,
              email: document.getElementById('pf-email').value,
              phone: document.getElementById('pf-phone').value,
              address: document.getElementById('pf-address').value
            };
            
            const endpoints = ['/api/users/me/', '/api/users/profile/'];
            let ok = false;
            
            for (const ep of endpoints) {
              const res = await window.api.fetchAPI(ep, { method: 'PATCH', body });
              if (res.ok) { 
                ok = true; 
                originalProfileData = { ...originalProfileData, ...body };
                break; 
              }
            }
            
            msg.className = ok ? 'small text-success' : 'small text-warning';
            msg.textContent = ok ? 'âœ… ä¿å­˜æˆåŠŸ' : 'âš ï¸ å½“å‰ç¯å¢ƒæœªå¼€æ”¾èµ„æ–™ä¿®æ”¹æ¥å£';
            msg.style.display = 'block';
            
          } catch (e) {
            msg.className = 'small text-danger';
            msg.textContent = 'âŒ ä¿å­˜å¤±è´¥';
            msg.style.display = 'block';
          } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = 'ğŸ’¾ ä¿å­˜èµ„æ–™';
          }
        });
        
        // é‡ç½®ä¸ªäººèµ„æ–™
        document.getElementById('pf-reset')?.addEventListener('click', () => {
          document.getElementById('pf-realname').value = originalProfileData.real_name || '';
          document.getElementById('pf-email').value = originalProfileData.email || '';
          document.getElementById('pf-phone').value = originalProfileData.phone || '';
          document.getElementById('pf-address').value = originalProfileData.address || '';
          
          const msg = document.getElementById('pf-msg');
          msg.style.display = 'none';
        });
      });

      async function requestDemote() {
        if (!confirm('ç¡®è®¤æäº¤é€€å‡ºå›¢é•¿ç”³è¯·ï¼Ÿ')) return;
        const reason = prompt('å¯é€‰ï¼šè¯´æ˜é€€å‡ºåŸå› ', '') || '';
        try {
          const res = await window.api.fetchAPI('/api/leader/demote/', { method: 'POST', body: { reason } });
          if (res.ok) {
            alert('é€€å‡ºç”³è¯·å·²æäº¤ï¼Œç­‰å¾…ç®¡ç†å‘˜å®¡æ‰¹');
            loadProfile();
          } else {
            const data = await res.json().catch(() => ({}));
            alert(data.error || 'æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
          }
        } catch (e) {
          alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        }
      }
    </script>
</body>
</html>


