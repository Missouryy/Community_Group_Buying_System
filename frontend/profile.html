<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ä¸ªäººèµ„æ–™ - ç¤¾åŒºå›¢è´­</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/apple-theme.css" rel="stylesheet">
    <link href="/styles.css" rel="stylesheet">
</head>
<body>
    <!-- å¯¼èˆªå°†ç”± nav.js åŠ¨æ€ç”Ÿæˆ -->

    <div class="container py-3">
            <main>
                <div id="page-profile" class="page">
                    <div class="row g-4">
                        <!-- ä¼šå‘˜ä¸­å¿ƒå¡ç‰‡ -->
                        <div class="col-12 col-lg-6">
                            <div class="card shadow-community lift">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="fs-1 me-3">ğŸ‘¤</div>
                                        <div>
                                            <h5 class="card-title mb-1">ä¼šå‘˜ä¸­å¿ƒ</h5>
                                            <div class="text-muted small">äº«å—ä¸“å±ä¼˜æƒ å’Œæƒç›Š</div>
                                        </div>
                                    </div>
                                    
                                    <div class="community-highlight mb-3">
                                        <div id="member-tier" class="fw-bold fs-5 mb-1">æ™®é€šä¼šå‘˜</div>
                                        <div class="text-muted small">å½“å‰ç§¯åˆ†ï¼š<span id="member-points" class="fw-semibold text-success">0</span> åˆ†</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <span class="small text-muted">å‡çº§è¿›åº¦</span>
                                            <span class="small text-muted">è·ç¦»ä¸‹ä¸€ç­‰çº§è¿˜éœ€ <span id="points-to-next" class="fw-semibold">0</span> åˆ†</span>
                                        </div>
                                        <div class="progress"><div id="member-progress" class="progress-bar" style="width:0%">0%</div></div>
                                    </div>
                                    
                                    <div class="row g-3 text-center">
                                        <div class="col-4">
                                            <div class="fs-6 fw-bold" id="total-orders">0</div>
                                            <div class="text-muted small">æ€»è®¢å•</div>
                                        </div>
                                        <div class="col-4">
                                            <div class="fs-6 fw-bold" id="total-savings">Â¥0</div>
                                            <div class="text-muted small">ç´¯è®¡èŠ‚çœ</div>
                                        </div>
                                        <div class="col-4">
                                            <div class="fs-6 fw-bold" id="join-days">0</div>
                                            <div class="text-muted small">åŠ å…¥å¤©æ•°</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ä¸ªäººèµ„æ–™å¡ç‰‡ -->
                        <div class="col-12 col-lg-6">
                            <div class="card shadow-community lift">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="fs-1 me-3">âœï¸</div>
                                        <div>
                                            <h5 class="card-title mb-1">ä¸ªäººèµ„æ–™</h5>
                                            <div class="text-muted small">å®Œå–„èµ„æ–™ï¼Œäº«å—æ›´å¥½æœåŠ¡</div>
                                        </div>
                                    </div>
                                    
                                    <form id="profile-form" class="vstack gap-3">
                                        <div>
                                            <label class="form-label fw-semibold">å§“å</label>
                                            <input type="text" id="pf-realname" class="form-control" placeholder="è¯·è¾“å…¥çœŸå®å§“å">
                                        </div>
                                        <div>
                                            <label class="form-label fw-semibold">é‚®ç®±</label>
                                            <input type="email" id="pf-email" class="form-control" placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€">
                                        </div>
                                        <div>
                                            <label class="form-label fw-semibold">æ‰‹æœºå·</label>
                                            <input type="tel" id="pf-phone" class="form-control" placeholder="è¯·è¾“å…¥æ‰‹æœºå·ç ">
                                        </div>
                                        <div>
                                            <label class="form-label fw-semibold">æ”¶è´§åœ°å€</label>
                                            <textarea id="pf-address" class="form-control" rows="2" placeholder="è¯·è¾“å…¥è¯¦ç»†æ”¶è´§åœ°å€"></textarea>
                                        </div>
                                        
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-primary flex-fill" id="pf-save" type="button">
                                                ğŸ’¾ ä¿å­˜èµ„æ–™
                                            </button>
                                            <button class="btn btn-outline-secondary" id="pf-reset" type="button">
                                                ğŸ”„ é‡ç½®
                                            </button>
                                        </div>
                                        <div id="pf-msg" class="small" style="display:none"></div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ç”³è¯·æˆä¸ºå›¢é•¿å¡ç‰‡ -->
                        <div class="col-12" id="leader-application-section">
                            <div class="card shadow-deal lift">
                                <div class="card-body">
                                    <div class="d-flex align-items-center justify-content-between mb-3">
                                        <div class="d-flex align-items-center">
                                            <div class="fs-1 me-3">ğŸ‘‘</div>
                                            <div>
                                                <h5 class="card-title mb-1">æˆä¸ºå›¢é•¿</h5>
                                                <div class="text-muted small">å‘èµ·æ‹¼å•ï¼Œèµšå–ä½£é‡‘ï¼ŒæœåŠ¡ç¤¾åŒº</div>
                                            </div>
                                        </div>
                                        <div id="leader-status-badge"></div>
                                    </div>
                                    
                                    <div id="leader-application-content">
                                        <!-- åŠ¨æ€å†…å®¹å°†ç”±JavaScriptå¡«å…… -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- è®¢å•å†å²æ‘˜è¦ -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <h6 class="mb-0">ğŸ“¦ æœ€è¿‘è®¢å•</h6>
                                        <a href="/orders.html" class="btn btn-outline-primary btn-sm">æŸ¥çœ‹å…¨éƒ¨</a>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="recent-orders">
                                        <!-- æœ€è¿‘è®¢å•åˆ—è¡¨ -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/nav.js"></script>
    <script>
      let originalProfileData = {};
      
      async function loadProfile() {
        const tokens = window.api.getTokens();
        if (!tokens.access) { window.location.href = '/login.html'; return; }
        
        // åŠ è½½ç”¨æˆ·åŸºæœ¬ä¿¡æ¯å’Œä¼šå‘˜ä¿¡æ¯
        const [meRes, tiersRes, ordersRes] = await Promise.all([
          window.api.fetchAPI('/api/users/me/'),
          window.api.fetchAPI('/api/memberships/tiers/').catch(() => null),
          window.api.fetchAPI('/api/me/orders/?limit=3').catch(() => null)
        ]);
        
        if (!meRes.ok) return;
        const me = await meRes.json();
        originalProfileData = { ...me };
        
        // æ›´æ–°ä¼šå‘˜ä¿¡æ¯
        const tierName = me.membership_tier?.tier_name || 'æ™®é€šä¼šå‘˜';
        const points = me.loyalty_points || 0;
        
        document.getElementById('member-tier').textContent = tierName;
        document.getElementById('member-points').textContent = points;
        
        // è®¡ç®—å‡çº§è¿›åº¦
        if (tiersRes && tiersRes.ok) {
          const tiers = await tiersRes.json();
          const currentRequired = me.membership_tier?.points_required || 0;
          const nextTier = tiers.find(t => t.points_required > currentRequired);
          const target = nextTier ? nextTier.points_required : currentRequired || 100;
          const ratio = Math.min(100, Math.round((points / target) * 100));
          
          document.getElementById('member-progress').style.width = ratio + '%';
          document.getElementById('member-progress').textContent = ratio + '%';
          document.getElementById('points-to-next').textContent = Math.max(0, target - points);
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        document.getElementById('total-orders').textContent = me.total_orders || 0;
        document.getElementById('total-savings').textContent = `Â¥${me.total_savings || 0}`;
        const joinDays = me.date_joined ? Math.floor((new Date() - new Date(me.date_joined)) / (1000 * 60 * 60 * 24)) : 0;
        document.getElementById('join-days').textContent = joinDays;

        // å¡«å……ä¸ªäººèµ„æ–™è¡¨å•
        document.getElementById('pf-realname').value = me.real_name || '';
        document.getElementById('pf-email').value = me.email || '';
        document.getElementById('pf-phone').value = me.phone || '';
        document.getElementById('pf-address').value = me.address || '';
        
        // åŠ è½½å›¢é•¿ç”³è¯·çŠ¶æ€
        loadLeaderApplicationStatus(me);
        
        // åŠ è½½æœ€è¿‘è®¢å•
        if (ordersRes && ordersRes.ok) {
          const orders = await ordersRes.json();
          loadRecentOrders(orders);
        }
      }
      
      async function loadLeaderApplicationStatus(user) {
        const badge = document.getElementById('leader-status-badge');
        const content = document.getElementById('leader-application-content');
        
        if (user.role === 'leader') {
          badge.innerHTML = '<span class="badge text-bg-success">å·²æ˜¯å›¢é•¿</span>';
          content.innerHTML = `
            <div class="community-highlight">
              <h6>ğŸ‰ æ­å–œï¼æ‚¨å·²ç»æ˜¯å›¢é•¿äº†</h6>
              <p class="text-muted mb-2">æ‚¨å¯ä»¥å‘èµ·æ‹¼å•ï¼Œç®¡ç†è®¢å•ï¼Œèµšå–ä½£é‡‘</p>
              <a href="/leader.html" class="btn btn-primary">è¿›å…¥å›¢é•¿é—¨æˆ·</a>
            </div>`;
        } else if (user.leader_status === 'pending') {
          badge.innerHTML = '<span class="badge text-bg-warning">å®¡æ ¸ä¸­</span>';
          content.innerHTML = `
            <div class="alert alert-warning">
              <h6>â° ç”³è¯·å®¡æ ¸ä¸­</h6>
              <p class="mb-0">æ‚¨çš„å›¢é•¿ç”³è¯·æ­£åœ¨å®¡æ ¸ä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…ç®¡ç†å‘˜å¤„ç†</p>
            </div>`;
        } else if (user.leader_status === 'rejected') {
          badge.innerHTML = '<span class="badge text-bg-danger">å·²æ‹’ç»</span>';
          content.innerHTML = `
            <div class="alert alert-danger">
              <h6>âŒ ç”³è¯·è¢«æ‹’ç»</h6>
              <p class="mb-2">${user.rejection_reason || 'å¾ˆé—æ†¾ï¼Œæ‚¨çš„å›¢é•¿ç”³è¯·æœªé€šè¿‡å®¡æ ¸'}</p>
              <button class="btn btn-warning btn-sm" onclick="reapplyLeader()">é‡æ–°ç”³è¯·</button>
            </div>`;
        } else {
          badge.innerHTML = '<span class="badge text-bg-secondary">å¯ç”³è¯·</span>';
          content.innerHTML = `
            <div class="row g-3">
              <div class="col-md-8">
                <h6>å›¢é•¿æƒç›Š</h6>
                <ul class="list-unstyled">
                  <li>âœ… å‘èµ·ç¤¾åŒºæ‹¼å•æ´»åŠ¨</li>
                  <li>âœ… èµšå–è®¢å•ä½£é‡‘ï¼ˆé€šå¸¸5-10%ï¼‰</li>
                  <li>âœ… ç®¡ç†æè´§å’Œé…é€</li>
                  <li>âœ… è·å¾—ä¸“å±å›¢é•¿æ ‡è¯†</li>
                </ul>
              </div>
              <div class="col-md-4 d-flex align-items-center">
                <button class="btn btn-warning w-100" onclick="showLeaderApplicationForm()">
                  <i class="bi bi-crown me-1"></i>ç”³è¯·æˆä¸ºå›¢é•¿
                </button>
              </div>
            </div>`;
        }
      }
      
      function loadRecentOrders(orders) {
        const container = document.getElementById('recent-orders');
        if (!orders || orders.length === 0) {
          container.innerHTML = '<div class="text-muted text-center py-3">æš‚æ— è®¢å•è®°å½•</div>';
          return;
        }
        
        container.innerHTML = orders.map(order => {
          const statusClass = order.status === 'completed' ? 'success' : order.status === 'successful' ? 'primary' : 'warning';
          const statusText = order.status === 'completed' ? 'å·²å®Œæˆ' : order.status === 'successful' ? 'æˆåŠŸ' : 'è¿›è¡Œä¸­';
          
          return `
            <div class="d-flex align-items-center justify-content-between py-2 border-bottom">
              <div>
                <div class="fw-semibold">è®¢å• #${order.id}</div>
                <div class="text-muted small">${new Date(order.created_at).toLocaleDateString()}</div>
              </div>
              <div class="text-end">
                <div class="fw-semibold">Â¥${order.total_price}</div>
                <span class="badge text-bg-${statusClass}">${statusText}</span>
              </div>
            </div>`;
        }).join('');
      }
      
      // å›¢é•¿ç”³è¯·ç›¸å…³å‡½æ•°
      function showLeaderApplicationForm() {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">ğŸ‘‘ ç”³è¯·æˆä¸ºå›¢é•¿</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="leader-application-form">
                  <div class="mb-3">
                    <label class="form-label">è”ç³»ç”µè¯ <span class="text-danger">*</span></label>
                    <input type="tel" class="form-control" id="app-phone" required>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">æ‰€åœ¨åœ°åŒº <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="app-address" placeholder="å¦‚ï¼šåŒ—äº¬å¸‚æœé˜³åŒºæŸæŸå°åŒº" required>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">ç”³è¯·ç†ç”±</label>
                    <textarea class="form-control" id="app-reason" rows="3" placeholder="è¯·ç®€å•è¯´æ˜æ‚¨ç”³è¯·æˆä¸ºå›¢é•¿çš„åŸå› å’Œä¼˜åŠ¿"></textarea>
                  </div>
                  <div class="alert alert-info">
                    <small>ğŸ“ æäº¤ç”³è¯·åï¼Œç®¡ç†å‘˜å°†åœ¨1-3ä¸ªå·¥ä½œæ—¥å†…å®Œæˆå®¡æ ¸</small>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="submitLeaderApplication()">æäº¤ç”³è¯·</button>
              </div>
            </div>
          </div>`;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        modal.addEventListener('hidden.bs.modal', () => modal.remove());
      }
      
      async function submitLeaderApplication() {
        const phone = document.getElementById('app-phone').value;
        const address = document.getElementById('app-address').value;
        const reason = document.getElementById('app-reason').value;
        
        if (!phone || !address) {
          alert('è¯·å¡«å†™å¿…è¦ä¿¡æ¯');
          return;
        }
        
        try {
          const res = await window.api.fetchAPI('/api/users/apply-leader/', {
            method: 'POST',
            body: { phone, address, reason }
          });
          
          if (res.ok) {
            alert('ç”³è¯·æäº¤æˆåŠŸï¼è¯·ç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸');
            bootstrap.Modal.getInstance(document.querySelector('.modal.show')).hide();
            loadProfile(); // é‡æ–°åŠ è½½é¡µé¢
          } else {
            alert('ç”³è¯·æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
          }
        } catch (error) {
          alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
        }
      }
      
      function reapplyLeader() {
        showLeaderApplicationForm();
      }
      
      document.addEventListener('DOMContentLoaded', () => {
        loadProfile();
        
        // ä¿å­˜ä¸ªäººèµ„æ–™
        document.getElementById('pf-save')?.addEventListener('click', async () => {
          const msg = document.getElementById('pf-msg');
          const saveBtn = document.getElementById('pf-save');
          
          msg.style.display = 'none';
          saveBtn.disabled = true;
          saveBtn.textContent = 'ä¿å­˜ä¸­...';
          
          try {
            const body = {
              real_name: document.getElementById('pf-realname').value,
              email: document.getElementById('pf-email').value,
              phone: document.getElementById('pf-phone').value,
              address: document.getElementById('pf-address').value
            };
            
            const endpoints = ['/api/users/me/', '/api/users/profile/'];
            let ok = false;
            
            for (const ep of endpoints) {
              const res = await window.api.fetchAPI(ep, { method: 'PATCH', body });
              if (res.ok) { 
                ok = true; 
                originalProfileData = { ...originalProfileData, ...body };
                break; 
              }
            }
            
            msg.className = ok ? 'small text-success' : 'small text-warning';
            msg.textContent = ok ? 'âœ… ä¿å­˜æˆåŠŸ' : 'âš ï¸ å½“å‰ç¯å¢ƒæœªå¼€æ”¾èµ„æ–™ä¿®æ”¹æ¥å£';
            msg.style.display = 'block';
            
          } catch (e) {
            msg.className = 'small text-danger';
            msg.textContent = 'âŒ ä¿å­˜å¤±è´¥';
            msg.style.display = 'block';
          } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = 'ğŸ’¾ ä¿å­˜èµ„æ–™';
          }
        });
        
        // é‡ç½®ä¸ªäººèµ„æ–™
        document.getElementById('pf-reset')?.addEventListener('click', () => {
          document.getElementById('pf-realname').value = originalProfileData.real_name || '';
          document.getElementById('pf-email').value = originalProfileData.email || '';
          document.getElementById('pf-phone').value = originalProfileData.phone || '';
          document.getElementById('pf-address').value = originalProfileData.address || '';
          
          const msg = document.getElementById('pf-msg');
          msg.style.display = 'none';
        });
      });
    </script>
</body>
</html>


