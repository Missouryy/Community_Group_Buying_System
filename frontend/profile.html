<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>‰∏™‰∫∫ËµÑÊñô - Á§æÂå∫Âõ¢Ë¥≠</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/apple-theme.css" rel="stylesheet">
    <link href="/styles.css" rel="stylesheet">
    <style>
        /* ‰ºòÂåñemojiÊòæÁ§∫ÔºåÈÅøÂÖçÊ®°Á≥ä */
        #member-tier-emoji,
        #admin-info-area > div > div > div:first-child,
        #leader-info-area > div > div > div:first-child {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            font-feature-settings: "liga";
        }
    </style>
</head>
<body>
    <!-- ÂØºËà™Â∞ÜÁî± nav.js Âä®ÊÄÅÁîüÊàê -->

    <div class="container py-3">
            <main>
                <div id="page-profile" class="page">
                    <div class="row g-4">
                        <!-- ‰ºöÂëò‰∏≠ÂøÉÂç°Áâá -->
                        <div class="col-12 col-lg-6">
                            <div class="card shadow-community lift">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="fs-1 me-3">üë§</div>
                                        <div>
                                            <h5 class="card-title mb-1">‰ºöÂëò‰∏≠ÂøÉ</h5>
                                            <div class="text-muted small">‰∫´Âèó‰∏ìÂ±û‰ºòÊÉ†ÂíåÊùÉÁõä</div>
                                        </div>
                                    </div>
                                    
                                    <!-- ÁÆ°ÁêÜÂëò‰ø°ÊÅØÂå∫ÂüüÔºà‰ªÖÁÆ°ÁêÜÂëòÂèØËßÅÔºâ -->
                                    <div id="admin-info-area" style="display:none" class="mb-3">
                                        <div class="d-flex align-items-center justify-content-between p-3 rounded" style="background: linear-gradient(135deg, rgba(255, 42, 0, 0.08) 0%, rgba(255, 42, 0, 0.05) 100%); border: 1.5px solid rgba(255, 42, 0, 0.2);">
                                            <div class="d-flex align-items-center">
                                                <div style="font-size: 2.5rem; line-height: 1;" class="me-3">‚öôÔ∏è</div>
                                                <div>
                                                    <div class="fw-bold fs-6 mb-1" style="color: #ff2a00;">Á≥ªÁªüÁÆ°ÁêÜÂëò</div>
                                                    <div class="text-muted small">Êã•ÊúâÁ≥ªÁªüÊúÄÈ´òÊùÉÈôêÔºåÁÆ°ÁêÜÊâÄÊúâÂäüËÉΩ</div>
                                                </div>
                                            </div>
                                            <a href="/admin.html" class="btn btn-danger btn-sm">ËøõÂÖ•ÁÆ°ÁêÜÂêéÂè∞</a>
                                        </div>
                                    </div>
                                    
                                    <!-- Âõ¢Èïø‰ø°ÊÅØÂå∫ÂüüÔºà‰ªÖÂõ¢ÈïøÂèØËßÅÔºâ -->
                                    <div id="leader-info-area" style="display:none" class="mb-3">
                                        <div class="d-flex align-items-center justify-content-between p-3 rounded" style="background: linear-gradient(135deg, rgba(255, 149, 0, 0.08) 0%, rgba(255, 159, 10, 0.05) 100%); border: 1.5px solid rgba(255, 149, 0, 0.2);">
                                            <div class="d-flex align-items-center">
                                                <div style="font-size: 2.5rem; line-height: 1;" class="me-3">üëë</div>
                                                <div>
                                                    <div class="fw-bold fs-6 mb-1" style="color: #FF9500;">Â∑≤Êàê‰∏∫Âõ¢Èïø</div>
                                                    <div class="text-muted small">ÊÇ®ÂèØ‰ª•ÂèëËµ∑ÊãºÂçïÔºåÁÆ°ÁêÜËÆ¢ÂçïÔºåËµöÂèñ‰Ω£Èáë</div>
                                                </div>
                                            </div>
                                            <a href="/leader.html" class="btn btn-warning btn-sm">ËøõÂÖ•Âõ¢ÈïøÈó®Êà∑</a>
                                        </div>
                                    </div>
                                    
                                    <!-- ‰ºöÂëòÁ≠âÁ∫ß‰ø°ÊÅØ -->
                                    <div class="mb-3 p-3 rounded" style="background: rgba(0, 122, 255, 0.05); border: 1.5px solid rgba(0, 122, 255, 0.1);">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div class="d-flex align-items-center">
                                                <div id="member-tier-emoji" style="font-size: 2.5rem; line-height: 1;" class="me-3">ü•â</div>
                                                <div>
                                                    <div id="member-tier" class="fw-bold fs-6 mb-0">Bronze</div>
                                                    <div class="text-muted small">‰ºöÂëòÁ≠âÁ∫ß</div>
                                                </div>
                                            </div>
                                            <div class="text-end">
                                                <div id="member-points" class="fw-bold text-primary" style="font-size: 2rem; line-height: 1;">0</div>
                                                <div class="text-muted small">ÂΩìÂâçÁßØÂàÜ</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <span class="small text-muted">ÂçáÁ∫ßËøõÂ∫¶</span>
                                            <span class="small text-muted">Ë∑ùÁ¶ª‰∏ã‰∏ÄÁ≠âÁ∫ßËøòÈúÄ <span id="points-to-next" class="fw-semibold">0</span> ÂàÜ</span>
                                        </div>
                                        <div class="progress"><div id="member-progress" class="progress-bar" style="width:0%">0%</div></div>
                                    </div>
                                    
                                    <div class="row g-3 text-center">
                                        <div class="col-4">
                                            <div class="fs-6 fw-bold" id="total-orders">0</div>
                                            <div class="text-muted small">ÊÄªËÆ¢Âçï</div>
                                        </div>
                                        <div class="col-4">
                                            <div class="fs-6 fw-bold" id="total-savings">¬•0</div>
                                            <div class="text-muted small">Á¥ØËÆ°ËäÇÁúÅ</div>
                                        </div>
                                        <div class="col-4">
                                            <div class="fs-6 fw-bold" id="join-days">0</div>
                                            <div class="text-muted small">Âä†ÂÖ•Â§©Êï∞</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ‰∏™‰∫∫ËµÑÊñôÂç°Áâá -->
                        <div class="col-12 col-lg-6">
                            <div class="card shadow-community lift">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="fs-1 me-3">‚úèÔ∏è</div>
                                        <div>
                                            <h5 class="card-title mb-1">‰∏™‰∫∫ËµÑÊñô</h5>
                                            <div class="text-muted small">ÂÆåÂñÑËµÑÊñôÔºå‰∫´ÂèóÊõ¥Â•ΩÊúçÂä°</div>
                                        </div>
                                    </div>
                                    
                                    <form id="profile-form" class="vstack gap-3">
                                        <div>
                                            <label class="form-label fw-semibold">ÂßìÂêç</label>
                                            <input type="text" id="pf-realname" class="form-control" placeholder="ËØ∑ËæìÂÖ•ÁúüÂÆûÂßìÂêç">
                                        </div>
                                        <div>
                                            <label class="form-label fw-semibold">ÈÇÆÁÆ±</label>
                                            <input type="email" id="pf-email" class="form-control" placeholder="ËØ∑ËæìÂÖ•ÈÇÆÁÆ±Âú∞ÂùÄ">
                                        </div>
                                        <div>
                                            <label class="form-label fw-semibold">ÊâãÊú∫Âè∑</label>
                                            <input type="tel" id="pf-phone" class="form-control" placeholder="ËØ∑ËæìÂÖ•ÊâãÊú∫Âè∑Á†Å">
                                        </div>
                                        <div>
                                            <label class="form-label fw-semibold">Êî∂Ë¥ßÂú∞ÂùÄ</label>
                                            <textarea id="pf-address" class="form-control" rows="2" placeholder="ËØ∑ËæìÂÖ•ËØ¶ÁªÜÊî∂Ë¥ßÂú∞ÂùÄ"></textarea>
                                        </div>
                                        
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-primary flex-fill" id="pf-save" type="button">
                                                üíæ ‰øùÂ≠òËµÑÊñô
                                            </button>
                                            <button class="btn btn-outline-secondary" id="pf-reset" type="button">
                                                üîÑ ÈáçÁΩÆ
                                            </button>
                                        </div>
                                        <div id="pf-msg" class="small" style="display:none"></div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- ËÆ¢ÂçïÂéÜÂè≤ÊëòË¶Å -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <h6 class="mb-0">üì¶ ÊúÄËøëËÆ¢Âçï</h6>
                                        <a href="/orders.html" class="btn btn-outline-primary btn-sm">Êü•ÁúãÂÖ®ÈÉ®</a>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="recent-orders">
                                        <!-- ÊúÄËøëËÆ¢ÂçïÂàóË°® -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/nav.js"></script>
    <script>
      let originalProfileData = {};
      
      async function loadProfile() {
        const tokens = window.api.getTokens();
        if (!tokens.access) { window.location.href = '/login.html'; return; }
        
        // Âä†ËΩΩÁî®Êà∑Âü∫Êú¨‰ø°ÊÅØÂíå‰ºöÂëò‰ø°ÊÅØ
        const [meRes, tiersRes, ordersRes] = await Promise.all([
          window.api.fetchAPI('/api/users/me/'),
          window.api.fetchAPI('/api/memberships/tiers/').catch(() => null),
          window.api.fetchAPI('/api/me/orders/?limit=3').catch(() => null)
        ]);
        
        if (!meRes.ok) return;
        const me = await meRes.json();
        originalProfileData = { ...me };
        
        // Êõ¥Êñ∞‰ºöÂëò‰ø°ÊÅØ
        const tierName = me.membership_tier?.tier_name || 'Bronze';
        const points = me.loyalty_points || 0;
        
        // Ê†πÊçÆ‰ºöÂëòÁ≠âÁ∫ßÊòæÁ§∫ÂØπÂ∫îemoji
        const tierEmojis = {
          'Bronze': 'ü•â',
          'Silver': 'ü•à',
          'Gold': 'ü•á',
          'Diamond': 'üíé',
          'ÈùíÈìú‰ºöÂëò': 'ü•â',
          'Èì∂Áâå‰ºöÂëò': 'ü•à',
          'ÈáëÁâå‰ºöÂëò': 'ü•á',
          'ÈíªÁü≥Áî®Êà∑': 'üíé'
        };
        const tierEmoji = tierEmojis[tierName] || 'ü•â';
        
        document.getElementById('member-tier').textContent = tierName;
        document.getElementById('member-tier-emoji').textContent = tierEmoji;
        document.getElementById('member-points').textContent = points;
        
        // ËÆ°ÁÆóÂçáÁ∫ßËøõÂ∫¶
        if (tiersRes && tiersRes.ok) {
          const tiers = await tiersRes.json();
          const currentRequired = me.membership_tier?.points_required || 0;
          const nextTier = tiers.find(t => t.points_required > currentRequired);
          const target = nextTier ? nextTier.points_required : currentRequired || 100;
          const ratio = Math.min(100, Math.round((points / target) * 100));
          
          document.getElementById('member-progress').style.width = ratio + '%';
          document.getElementById('member-progress').textContent = ratio + '%';
          document.getElementById('points-to-next').textContent = Math.max(0, target - points);
        }
        
        // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
        document.getElementById('total-orders').textContent = me.total_orders || 0;
        document.getElementById('total-savings').textContent = `¬•${me.total_savings || 0}`;
        const joinDays = me.date_joined ? Math.floor((new Date() - new Date(me.date_joined)) / (1000 * 60 * 60 * 24)) : 0;
        document.getElementById('join-days').textContent = joinDays;

        // Â°´ÂÖÖ‰∏™‰∫∫ËµÑÊñôË°®Âçï
        document.getElementById('pf-realname').value = me.real_name || '';
        document.getElementById('pf-email').value = me.email || '';
        document.getElementById('pf-phone').value = me.phone || '';
        document.getElementById('pf-address').value = me.address || '';
        
        // Âä†ËΩΩËßíËâ≤‰ø°ÊÅØÔºàÁÆ°ÁêÜÂëò/Âõ¢ÈïøÔºâ
        loadRoleInfo(me);
        
        // Âä†ËΩΩÊúÄËøëËÆ¢Âçï
        if (ordersRes && ordersRes.ok) {
          const orders = await ordersRes.json();
          loadRecentOrders(orders);
        }
      }
      
      function loadRoleInfo(user) {
        const adminArea = document.getElementById('admin-info-area');
        const leaderArea = document.getElementById('leader-info-area');
        
        // ÊòæÁ§∫ÁÆ°ÁêÜÂëò‰ø°ÊÅØ
        if (adminArea) {
          adminArea.style.display = user.role === 'admin' ? '' : 'none';
        }
        
        // ÊòæÁ§∫Âõ¢Èïø‰ø°ÊÅØ
        if (leaderArea) {
          leaderArea.style.display = user.role === 'leader' ? '' : 'none';
        }
      }
      
      function loadRecentOrders(orders) {
        const container = document.getElementById('recent-orders');
        if (!orders || orders.length === 0) {
          container.innerHTML = '<div class="text-muted text-center py-3">ÊöÇÊó†ËÆ¢ÂçïËÆ∞ÂΩï</div>';
          return;
        }

        const formatDate = (iso) => {
          const d = new Date(iso);
          return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        };

        const toStatus = (status) => {
          if (status === 'completed') return { cls: 'success', text: 'Â∑≤ÂÆåÊàê' };
          if (status === 'successful') return { cls: 'primary', text: 'ÊàêÂäü' };
          if (status === 'ready_for_pickup') return { cls: 'info', text: 'ÂæÖÊèêË¥ß' };
          if (status === 'pending_payment') return { cls: 'warning', text: 'ÂæÖÊîØ‰ªò' };
          if (status === 'canceled') return { cls: 'secondary', text: 'Â∑≤ÂèñÊ∂à' };
          return { cls: 'warning', text: 'ËøõË°å‰∏≠' };
        };

        const items = orders.map(order => {
          const st = toStatus(order.status);
          const title = order.product_name ? `${order.product_name} √ó ${order.quantity || 1}` : `ËÆ¢Âçï #${order.id}`;
          const meta = `ËÆ¢Âçï #${order.id} ¬∑ ${formatDate(order.created_at)}`;
          const amount = `¬•${(order.total_price ?? order.amount ?? 0)}`;

        return `
          <li class="list-apple__item">
            <div class="list-apple__left">
              <div class="list-apple__title">${title}</div>
              <div class="list-apple__meta">${meta}</div>
            </div>
            <div class="list-apple__right">
              <div class="fw-semibold">${amount}</div>
              <span class="badge text-bg-${st.cls}">${st.text}</span>
            </div>
          </li>`;
        }).join('');

        container.innerHTML = `<ul class="list-apple">${items}</ul>`;
      }
      
      // Âõ¢ÈïøÁî≥ËØ∑Áõ∏ÂÖ≥ÂáΩÊï∞
      function showLeaderApplicationForm() {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">üëë Áî≥ËØ∑Êàê‰∏∫Âõ¢Èïø</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="leader-application-form">
                  <div class="mb-3">
                    <label class="form-label">ËÅîÁ≥ªÁîµËØù <span class="text-danger">*</span></label>
                    <input type="tel" class="form-control" id="app-phone" required>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">ÊâÄÂú®Âú∞Âå∫ <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="app-address" placeholder="Â¶ÇÔºöÂåó‰∫¨Â∏ÇÊúùÈò≥Âå∫ÊüêÊüêÂ∞èÂå∫" required>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Áî≥ËØ∑ÁêÜÁî±</label>
                    <textarea class="form-control" id="app-reason" rows="3" placeholder="ËØ∑ÁÆÄÂçïËØ¥ÊòéÊÇ®Áî≥ËØ∑Êàê‰∏∫Âõ¢ÈïøÁöÑÂéüÂõ†Âíå‰ºòÂäø"></textarea>
                  </div>
                  <div class="alert alert-info">
                    <small>üìù Êèê‰∫§Áî≥ËØ∑ÂêéÔºåÁÆ°ÁêÜÂëòÂ∞ÜÂú®1-3‰∏™Â∑•‰ΩúÊó•ÂÜÖÂÆåÊàêÂÆ°Ê†∏</small>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÂèñÊ∂à</button>
                <button type="button" class="btn btn-primary" onclick="submitLeaderApplication()">Êèê‰∫§Áî≥ËØ∑</button>
              </div>
            </div>
          </div>`;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        modal.addEventListener('hidden.bs.modal', () => modal.remove());
      }
      
      async function submitLeaderApplication() {
        const phone = document.getElementById('app-phone').value;
        const address = document.getElementById('app-address').value;
        const reason = document.getElementById('app-reason').value;
        
        if (!phone || !address) {
          alert('ËØ∑Â°´ÂÜôÂøÖË¶Å‰ø°ÊÅØ');
          return;
        }
        
        try {
          const res = await window.api.fetchAPI('/api/users/apply-leader/', {
            method: 'POST',
            body: { phone, address, reason }
          });
          
          if (res.ok) {
            alert('Áî≥ËØ∑Êèê‰∫§ÊàêÂäüÔºÅËØ∑Á≠âÂæÖÁÆ°ÁêÜÂëòÂÆ°Ê†∏');
            bootstrap.Modal.getInstance(document.querySelector('.modal.show')).hide();
            loadProfile(); // ÈáçÊñ∞Âä†ËΩΩÈ°µÈù¢
          } else {
            alert('Áî≥ËØ∑Êèê‰∫§Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
          }
        } catch (error) {
          alert('ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï');
        }
      }
      
      function reapplyLeader() {
        showLeaderApplicationForm();
      }
      
      document.addEventListener('DOMContentLoaded', () => {
        loadProfile();
        
        // ‰øùÂ≠ò‰∏™‰∫∫ËµÑÊñô
        document.getElementById('pf-save')?.addEventListener('click', async () => {
          const msg = document.getElementById('pf-msg');
          const saveBtn = document.getElementById('pf-save');
          
          msg.style.display = 'none';
          saveBtn.disabled = true;
          saveBtn.textContent = '‰øùÂ≠ò‰∏≠...';
          
          try {
            const body = {
              real_name: document.getElementById('pf-realname').value,
              email: document.getElementById('pf-email').value,
              phone: document.getElementById('pf-phone').value,
              address: document.getElementById('pf-address').value
            };
            
            const endpoints = ['/api/users/me/', '/api/users/profile/'];
            let ok = false;
            
            for (const ep of endpoints) {
              const res = await window.api.fetchAPI(ep, { method: 'PATCH', body });
              if (res.ok) { 
                ok = true; 
                originalProfileData = { ...originalProfileData, ...body };
                break; 
              }
            }
            
            msg.className = ok ? 'small text-success' : 'small text-warning';
            msg.textContent = ok ? '‚úÖ ‰øùÂ≠òÊàêÂäü' : '‚ö†Ô∏è ÂΩìÂâçÁéØÂ¢ÉÊú™ÂºÄÊîæËµÑÊñô‰øÆÊîπÊé•Âè£';
            msg.style.display = 'block';
            
          } catch (e) {
            msg.className = 'small text-danger';
            msg.textContent = '‚ùå ‰øùÂ≠òÂ§±Ë¥•';
            msg.style.display = 'block';
          } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = 'üíæ ‰øùÂ≠òËµÑÊñô';
          }
        });
        
        // ÈáçÁΩÆ‰∏™‰∫∫ËµÑÊñô
        document.getElementById('pf-reset')?.addEventListener('click', () => {
          document.getElementById('pf-realname').value = originalProfileData.real_name || '';
          document.getElementById('pf-email').value = originalProfileData.email || '';
          document.getElementById('pf-phone').value = originalProfileData.phone || '';
          document.getElementById('pf-address').value = originalProfileData.address || '';
          
          const msg = document.getElementById('pf-msg');
          msg.style.display = 'none';
        });
      });

      async function requestDemote() {
        if (!confirm('Á°ÆËÆ§Êèê‰∫§ÈÄÄÂá∫Âõ¢ÈïøÁî≥ËØ∑Ôºü')) return;
        const reason = prompt('ÂèØÈÄâÔºöËØ¥ÊòéÈÄÄÂá∫ÂéüÂõ†', '') || '';
        try {
          const res = await window.api.fetchAPI('/api/leader/demote/', { method: 'POST', body: { reason } });
          if (res.ok) {
            alert('ÈÄÄÂá∫Áî≥ËØ∑Â∑≤Êèê‰∫§ÔºåÁ≠âÂæÖÁÆ°ÁêÜÂëòÂÆ°Êâπ');
            loadProfile();
          } else {
            const data = await res.json().catch(() => ({}));
            alert(data.error || 'Êèê‰∫§Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
          }
        } catch (e) {
          alert('ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï');
        }
      }
    </script>
</body>
</html>


