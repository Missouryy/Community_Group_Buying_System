<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ç¤¾åŒºå›¢è´­ - é¦–é¡µ</title>
    <!-- æ€§èƒ½ä¼˜åŒ–ï¼šé¢„è¿æ¥CDN -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <!-- å…³é”®CSSï¼šé˜²æ­¢emojié—ªçƒ -->
    <style>
        body,*{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji",sans-serif!important}
        
        /* Particle Canvas Background */
        #particles-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/theme.css" rel="stylesheet">
    <link href="/styles.css" rel="stylesheet">
</head>
<body>
    <!-- Particle Canvas Background -->
    <canvas id="particles-canvas"></canvas>
    <!-- å¯¼èˆªå°†ç”± nav.js åŠ¨æ€ç”Ÿæˆ -->

    <main class="container py-5">
        <!-- ç¤¾åŒºå›¢è´­æ¨ªå¹… -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="text-center" style="padding: 4rem 0 3rem 0;">
                    <h1 class="display-3 fw-semibold mb-3" style="font-size: 5rem; letter-spacing: -0.02em; color: #1d1d1f;">
                        ç¤¾ åŒº å›¢ è´­ ç³» ç»Ÿ
                    </h1>
                    <p class="lead text-muted mb-5" style="font-size: 1.5rem; font-weight: 400; max-width: 600px; margin-left: auto; margin-right: auto;">
                        é‚» é‡Œ å…± äº« ï¼Œ æ–° é²œ åˆ° å®¶
                    </p>
                    
                    <div class="row justify-content-center mt-5">
                        <div class="col-auto px-5">
                            <div class="d-flex flex-column align-items-center">
                                <div class="display-4 fw-semibold mb-1" id="total-active-groups" style="font-size: 3rem; color: #1d1d1f;">0</div>
                                <div class="small text-muted" style="font-size: 0.875rem; letter-spacing: 0.5px;">æ´»è·ƒæ‹¼å•</div>
                            </div>
                        </div>
                        <div class="col-auto px-5">
                            <div class="d-flex flex-column align-items-center">
                                <div class="display-4 fw-semibold mb-1" id="total-participants" style="font-size: 3rem; color: #1d1d1f;">0</div>
                                <div class="small text-muted" style="font-size: 0.875rem; letter-spacing: 0.5px;">å‚å›¢äººæ•°</div>
                            </div>
                        </div>
                        <div class="col-auto px-5">
                            <div class="d-flex flex-column align-items-center">
                                <div class="display-4 fw-semibold mb-1" id="total-savings" style="font-size: 3rem; color: #1d1d1f;">Â¥0</div>
                                <div class="small text-muted" style="font-size: 0.875rem; letter-spacing: 0.5px;">å·²çœé‡‘é¢</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¿«æ·å…¥å£ -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="d-flex gap-3 flex-wrap align-items-center justify-content-between">
                    <div class="d-flex gap-3 flex-wrap">
                        <button class="btn btn-outline-secondary" onclick="filterGroupBuys('all')">
                            ğŸ“‹ å…¨éƒ¨æ‹¼å•
                        </button>
                        <button class="btn btn-outline-primary" onclick="filterGroupBuys('fresh')">
                            ğŸ¥¬ ç”Ÿé²œæœè”¬
                        </button>
                        <button class="btn btn-outline-primary" onclick="filterGroupBuys('meat')">
                            ğŸ¥© è‚‰ç¦½è›‹ç±»
                        </button>
                        <button class="btn btn-outline-primary" onclick="filterGroupBuys('daily')">
                            ğŸ§´ æ—¥ç”¨ç™¾è´§
                        </button>
                    </div>
                    
                    <!-- æœç´¢æ¡† -->
                    <div class="d-flex align-items-center gap-2" style="min-width: 300px;">
                        <div class="input-group form-control d-flex align-items-center p-0 overflow-hidden">
                            <span class="input-group-text border-0 bg-transparent pe-0">
                                ğŸ”
                            </span>
                            <input 
                                type="text" 
                                class="form-control border-0 shadow-none bg-transparent ps-2 pe-2" 
                                id="search-input" 
                                placeholder="æœç´¢å•†å“åç§°..."
                                oninput="searchGroupBuys(this.value)"
                            >
                            <button 
                                class="btn border-0 bg-transparent ps-0 pe-2 text-muted" 
                                type="button"
                                id="clear-search"
                                onclick="clearSearch()"
                                style="display: none;"
                            >
                            âœ–ï¸
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ‹¼å•åˆ—è¡¨ -->
        <div class="d-flex justify-content-between align-items-end mb-3">
            <div>
                <h3 class="m-0">ğŸ›’ æ­£åœ¨è¿›è¡Œçš„æ‹¼å•</h3>
            </div>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">æ’åºï¼š</span>
                <select class="form-select form-select-sm" style="width: 115px;" onchange="sortGroupBuys(this.value)">
                    <option value="time">æœ€æ–°å‘å¸ƒ</option>
                    <option value="progress">å‚å›¢äººæ•°</option>
                    <option value="price">ä»·æ ¼å‡åº</option>
                    <option value="ending">å³å°†ç»“æŸ</option>
                </select>
            </div>
        </div>
        <div id="groupbuy-list" class="row g-4"></div>

        <!-- ä¸ªæ€§åŒ–æ¨è -->
        <section class="section mt-5">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h3 class="m-0">ğŸ’¡ ä¸ºä½ æ¨è</h3>
                </div>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="refresh-recos">
                    ğŸ”„ æ¢ä¸€æ‰¹
                </button>
            </div>
            <div id="reco-list" class="row g-4"></div>
        </section>

    </main>

    <!-- Join Modal -->
    <div class="modal fade" id="joinModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">å‚ä¸æ‹¼å•</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="ratio-16x9 me-3" style="width:120px"><img id="join-image" alt=""></div>
                        <div>
                            <div id="join-name" class="fw-semibold"></div>
                            <div class="text-muted small">ä»·æ ¼ï¼š<span id="join-price">-</span></div>
                            <div class="text-muted small">å·²å‚ï¼š<span id="join-current">0</span> / ç›®æ ‡ï¼š<span id="join-target">0</span></div>
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">é€‰æ‹©æ•°é‡</label>
                        <input type="number" class="form-control" id="join-qty" value="1" min="1">
                        <input type="hidden" id="join-id">
                    </div>
                </div>
                <div class="modal-footer d-flex justify-content-between">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-primary" id="join-submit">
                            ç«‹å³å‚å›¢
                        </button>
                        <div class="dropdown">
                            <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                å‚å›¢å¹¶æ”¯ä»˜
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" data-payment="wechat">ğŸ’¬ å¾®ä¿¡æ”¯ä»˜</a></li>
                                <li><a class="dropdown-item" href="#" data-payment="alipay">ğŸ’° æ”¯ä»˜å®æ”¯ä»˜</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/nav.js"></script>
    <script src="/js/payment.js"></script>
    <script src="/js/websocket.js"></script>
    <script src="/js/user.js"></script>
    <script>
        // ========== Particle Effect ==========
        (function() {
            const canvas = document.getElementById('particles-canvas');
            const ctx = canvas.getContext('2d');
            let particles = [];
            let animationId;
            
            // Set canvas size
            function setCanvasSize() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            
            setCanvasSize();
            window.addEventListener('resize', () => {
                setCanvasSize();
                initParticles();
            });
            
            // Particle class
            class Particle {
                constructor() {
                    this.reset();
                }
                
                reset() {
                    this.x = Math.random() * canvas.width;
                    this.y = Math.random() * canvas.height;
                    this.size = Math.random() * 2.5 + 1; // Larger particles (1-3.5px)
                    this.speedX = Math.random() * 0.4 - 0.2;
                    this.speedY = Math.random() * 0.4 - 0.2;
                    this.opacity = Math.random() * 0.4 + 0.3; // More visible (0.3-0.7)
                }
                
                update() {
                    this.x += this.speedX;
                    this.y += this.speedY;
                    
                    // Wrap around screen
                    if (this.x > canvas.width) this.x = 0;
                    if (this.x < 0) this.x = canvas.width;
                    if (this.y > canvas.height) this.y = 0;
                    if (this.y < 0) this.y = canvas.height;
                }
                
                draw() {
                    // Check if dark mode is enabled (System preference or data-bs-theme attribute)
                    const isSystemDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                    const isAppDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
                    const isDarkMode = isAppDark || (isSystemDark && !document.documentElement.getAttribute('data-bs-theme'));
                    
                    const particleColor = isDarkMode ? '95, 99, 104' : '189, 193, 198'; // Lighter gray for dark mode
                    
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(${particleColor}, ${this.opacity})`;
                    ctx.fill();
                }
            }
            
            // Initialize particles - more particles
            function initParticles() {
                particles = [];
                const particleCount = Math.floor((canvas.width * canvas.height) / 18000); // More dense
                for (let i = 0; i < particleCount; i++) {
                    particles.push(new Particle());
                }
            }
            
            // Draw connections - more visible
            function drawConnections() {
                // Check if dark mode is enabled
                const isSystemDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                const isAppDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
                const isDarkMode = isAppDark || (isSystemDark && !document.documentElement.getAttribute('data-bs-theme'));
                
                const connectionColor = isDarkMode ? '95, 99, 104' : '189, 193, 198'; // Lighter gray for dark mode
                
                for (let i = 0; i < particles.length; i++) {
                    for (let j = i + 1; j < particles.length; j++) {
                        const dx = particles[i].x - particles[j].x;
                        const dy = particles[i].y - particles[j].y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < 120) { // Longer connection distance
                            ctx.beginPath();
                            ctx.strokeStyle = `rgba(${connectionColor}, ${0.15 * (1 - distance / 120)})`; // More visible
                            ctx.lineWidth = 0.8;
                            ctx.moveTo(particles[i].x, particles[i].y);
                            ctx.lineTo(particles[j].x, particles[j].y);
                            ctx.stroke();
                        }
                    }
                }
            }
            
            // Animation loop
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                particles.forEach(particle => {
                    particle.update();
                    particle.draw();
                });
                
                drawConnections();
                
                animationId = requestAnimationFrame(animate);
            }
            
            initParticles();
            animate();

            // Listen for theme changes observer
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'data-bs-theme') {
                        // Trigger redraw implicitly on next frame
                    }
                });
            });
            observer.observe(document.documentElement, { attributes: true });

        })();

      // é¦–é¡µç‰¹å®šé€»è¾‘
      document.addEventListener('DOMContentLoaded', () => {
        // è¿æ¥WebSocketçŠ¶æ€åˆ°å¯¼èˆªç³»ç»Ÿ
        if (window.websocket && window.navSystem) {
          const originalShowStatus = window.websocket.showConnectionStatus || function() {};
          window.websocket.showConnectionStatus = function(status) {
            window.navSystem.setWebSocketStatus(status, status === 'connected' ? 'å®æ—¶è¿æ¥' : 'è¿æ¥æ–­å¼€');
          };
        }
        
        // å¤„ç†æ”¯ä»˜æ–¹å¼ä¸‹æ‹‰èœå•ç‚¹å‡»
        document.addEventListener('click', async (e) => {
          const paymentLink = e.target.closest('.dropdown-menu a[data-payment]');
          if (paymentLink) {
            e.preventDefault();
            const paymentMethod = paymentLink.getAttribute('data-payment');
            
            // å…ˆæ£€æŸ¥æ˜¯å¦å·²å¡«å†™æ•°é‡å’Œé€‰æ‹©äº†æ‹¼å•
            const joinId = document.getElementById('join-id')?.value;
            const quantity = document.getElementById('join-qty')?.value;
            
            if (!joinId || !quantity) {
              alert('è¯·å…ˆé€‰æ‹©æ‹¼å•æ•°é‡');
              return;
            }
            
            try {
              // 1. åˆ›å»ºè®¢å•
              const res = await window.api.fetchAPI(`/api/group-buys/${joinId}/join/`, { 
                method: 'POST', 
                body: { quantity: parseInt(quantity) } 
              });
              
              if (res.ok) {
                const data = await res.json();
                
                // å…³é—­å‚å›¢æ¨¡æ€æ¡†
                const joinModal = document.getElementById('joinModal');
                if (joinModal) {
                  const modalInstance = bootstrap.Modal.getInstance(joinModal);
                  if (modalInstance) modalInstance.hide();
                }
                
                // 2. ç«‹å³å‘èµ·æ”¯ä»˜
                if (data.order_id && window.payment) {
                  await window.payment.initiatePayment(data.order_id, paymentMethod);
                } else {
                  alert('è®¢å•åˆ›å»ºæˆåŠŸï¼Œä½†æ— æ³•å‘èµ·æ”¯ä»˜');
                }
              } else {
                const errorData = await res.json().catch(() => ({}));
                alert(errorData.error || 'å‚å›¢å¤±è´¥ï¼Œè¯·é‡è¯•');
              }
            } catch (error) {
              console.error('æ”¯ä»˜æµç¨‹é”™è¯¯:', error);
              alert('æ”¯ä»˜å¤±è´¥: ' + error.message);
            }
          }
        });
      });
    </script>
</body>
</html>


