<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ç™»å½• - ç¤¾åŒºå›¢è´­</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/apple-theme.css" rel="stylesheet">
    <link href="/styles.css?v=2" rel="stylesheet">
</head>
<body class="login-bg d-flex align-items-center py-4">
    <div class="emoji-field" aria-hidden="true"></div>
    <main class="form-signin w-100 m-auto">
        <div class="glass shadow-sm p-4">
            <div class="d-flex justify-content-center mb-3">
                <div class="segmented-control">
                    <button type="button" class="segment active" data-tab="login">ç™»å½•</button>
                    <button type="button" class="segment" data-tab="register">æ³¨å†Œ</button>
                </div>
            </div>

            <!-- ç™»å½•è¡¨å• -->
            <form id="login-form">
                <div class="form-floating mb-2">
                    <input type="text" class="form-control" id="username" placeholder="ç”¨æˆ·å" required>
                    <label for="username">ç”¨æˆ·å</label>
                </div>
                <div class="form-floating mb-2">
                    <input type="password" class="form-control" id="password" placeholder="å¯†ç " required>
                    <label for="password">å¯†ç </label>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="rememberMe" checked>
                        <label class="form-check-label" for="rememberMe">è®°ä½æˆ‘</label>
                    </div>
                    <a class="small text-muted" href="#" onclick="return false;">å¿˜è®°å¯†ç ï¼Ÿ</a>
                </div>
                <button class="btn btn-primary w-100 py-2" type="submit">ç™»å½•</button>
                <div id="login-error" class="text-danger small mt-2" style="display:none"></div>
            </form>

            <!-- æ³¨å†Œè¡¨å• -->
            <form id="register-form" style="display:none">
                <div class="form-floating mb-2">
                    <input type="text" class="form-control" id="reg-username" placeholder="ç”¨æˆ·å" required>
                    <label for="reg-username">ç”¨æˆ·å</label>
                </div>
                <div class="form-floating mb-2">
                    <input type="email" class="form-control" id="reg-email" placeholder="é‚®ç®±ï¼ˆå¯é€‰ï¼‰">
                    <label for="reg-email">é‚®ç®±ï¼ˆå¯é€‰ï¼‰</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="password" class="form-control" id="reg-password" placeholder="å¯†ç " required>
                    <label for="reg-password">å¯†ç </label>
                </div>
                <button class="btn btn-primary w-100 py-2" type="submit" id="btn-register">æ³¨å†Œå¹¶ç™»å½•</button>
                <div id="register-error" class="text-danger small mt-2" style="display:none"></div>
            </form>
        </div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/api.js?v=2"></script>
    <script src="/js/auth.js?v=2"></script>
    <script>
        // Segmented control toggle
        document.querySelectorAll('.segment').forEach(seg => {
            seg.addEventListener('click', () => {
                document.querySelectorAll('.segment').forEach(s => s.classList.remove('active'));
                seg.classList.add('active');
                const tab = seg.getAttribute('data-tab');
                document.getElementById('login-form').style.display = (tab === 'login') ? '' : 'none';
                document.getElementById('register-form').style.display = (tab === 'register') ? '' : 'none';
            });
        });

        // Login submit
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const persist = document.getElementById('rememberMe').checked;
            const errorEl = document.getElementById('login-error');
            errorEl.style.display = 'none';
            try {
                await window.auth.login(username, password, persist);
            } catch (err) {
                errorEl.textContent = err.message || 'ç™»å½•å¤±è´¥';
                errorEl.style.display = 'block';
            }
        });

        // Register submit with graceful fallback if endpoint missing
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('reg-username').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-password').value.trim();
            const errorEl = document.getElementById('register-error');
            errorEl.style.display = 'none';
            const btn = document.getElementById('btn-register');
            btn.disabled = true; btn.textContent = 'æ­£åœ¨æ³¨å†Œ...';
            try {
                const payload = email ? { username, email, password } : { username, password };
                const endpoints = ['/api/register/', '/api/users/register/', '/api/users/'];
                let success = false;
                for (const ep of endpoints) {
                    const res = await window.api.fetchAPI(ep, { method: 'POST', body: payload });
                    if (res.ok) { success = true; break; }
                }
                if (!success) {
                    throw new Error('æ³¨å†Œæš‚ä¸å¯ç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜å¼€é€š');
                }
                // Auto login after successful registration
                await window.auth.login(username, password, true);
            } catch (err) {
                errorEl.textContent = err.message || 'æ³¨å†Œå¤±è´¥';
                errorEl.style.display = 'block';
            } finally {
                btn.disabled = false; btn.textContent = 'æ³¨å†Œå¹¶ç™»å½•';
            }
        });

        // Emoji ç‚¹çŠ¶åˆ†å¸ƒç”Ÿæˆ
        (function () {
            const field = document.querySelector('.emoji-field');
            if (!field) return;
            const EMOJI_STRING = 'ğŸ›’ğŸ§ºğŸ“¦ğŸ’°ğŸ‰ğŸ›ï¸ğŸ¥¬ğŸ¥¦ğŸ¥•ğŸ…ğŸŠğŸ‡ğŸ‰ğŸˆğŸğŸğŸ“ğŸ¥‘ğŸ¥­ğŸ’ğŸ¥ğŸğŸŒğŸŒ½ğŸğŸ¥¯ğŸ§€ğŸ¥›ğŸ²ğŸ±ğŸšğŸ—ğŸ¤ğŸ™ğŸ§ƒ';
            const EMOJIS = Array.from(EMOJI_STRING);

            const HEX_HORIZONTAL_GAP = 116; // pxï¼Œæ§åˆ¶èœ‚çªå•å…ƒå®½åº¦
            const HEX_VERTICAL_GAP = Math.round(HEX_HORIZONTAL_GAP * Math.sqrt(3) / 2); // å…­è¾¹å½¢å‚ç›´é—´è·
            const H_MARGIN_FACTOR = 0.6;
            const V_MARGIN_FACTOR = 0.65;
            const BASE_FONT_SIZE = 36;
            const SCALE_MIN = 0.8;
            const SCALE_MAX = 1.2;

            function clearField() {
                field.innerHTML = '';
            }

            function populate() {
                clearField();
                const rect = field.getBoundingClientRect();
                const width = rect.width || window.innerWidth;
                const height = rect.height || window.innerHeight;
                const marginX = HEX_HORIZONTAL_GAP * H_MARGIN_FACTOR;
                const marginY = HEX_VERTICAL_GAP * V_MARGIN_FACTOR;
                const cols = Math.ceil((width + marginX * 2) / HEX_HORIZONTAL_GAP) + 1;
                const rows = Math.ceil((height + marginY * 2) / HEX_VERTICAL_GAP) + 1;

                let index = 0;
                for (let row = -1; row <= rows; row++) {
                    const offsetX = (row % 2 !== 0) ? HEX_HORIZONTAL_GAP / 2 : 0;
                    const baseY = row * HEX_VERTICAL_GAP;
                    if (baseY < -marginY || baseY > height + marginY) continue;

                    for (let col = -1; col <= cols; col++) {
                        const baseX = col * HEX_HORIZONTAL_GAP + offsetX;
                        if (baseX < -marginX || baseX > width + marginX) continue;

                        const emoji = EMOJIS[index % EMOJIS.length];
                        const span = document.createElement('span');
                        span.className = 'emoji';
                        span.textContent = emoji;

                        // è½»å¾®æŠ–åŠ¨ï¼Œä¿æŒè‡ªç„¶ç”ŸåŠ¨
                        const jitterX = ((index % 5) - 2) * 3.4;
                        const jitterY = (((index + 3) % 5) - 2) * 3;
                        const sizeScale = SCALE_MIN + (Math.random() * (SCALE_MAX - SCALE_MIN));
                        const size = BASE_FONT_SIZE * sizeScale;

                        span.style.left = baseX + jitterX - size / 2 + 'px';
                        span.style.top = baseY + jitterY - size / 2 + 'px';
                        span.style.fontSize = size + 'px';
                        span.style.animationDuration = 42 + (index % 7) * 6 + 's';
                        span.style.animationDelay = ((index % 9) - 4) * 3 + 's';
                        span.style.setProperty('--emoji-scale', sizeScale.toFixed(3));
                        span.dataset.scale = sizeScale.toFixed(3);

                        field.appendChild(span);
                        index++;
                    }
                }
            }

            // åˆå§‹åŒ– & è‡ªé€‚åº”
            populate();
            let resizeTimer = null;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(populate, 120);
            });

            // æ‹–æ‹½å›å¼¹äº’åŠ¨
            const activePointers = new Map();

            function initiateDrag(event, target) {
                const pointerId = event.pointerId || 'mouse';
                const rect = target.getBoundingClientRect();
                const startX = event.clientX;
                const startY = event.clientY;
                const originLeft = parseFloat(target.style.left || 0);
                const originTop = parseFloat(target.style.top || 0);

                activePointers.set(pointerId, {
                    target,
                    startX,
                    startY,
                    originLeft,
                    originTop,
                    startTime: performance.now()
                });

                target.style.transition = 'none';
                target.setPointerCapture && target.setPointerCapture(pointerId);
            }

            function updateDrag(event) {
                const pointerId = event.pointerId || 'mouse';
                const drag = activePointers.get(pointerId);
                if (!drag) return;

                event.preventDefault();

                const dx = event.clientX - drag.startX;
                const dy = event.clientY - drag.startY;

                drag.target.style.left = drag.originLeft + dx + 'px';
                drag.target.style.top = drag.originTop + dy + 'px';

                const scale = parseFloat(drag.target.dataset.scale || 1);
                const pressFactor = Math.max(1.05, scale + 0.25);
                drag.target.style.transform = `scale(${pressFactor})`;
            }

            function endDrag(event) {
                const pointerId = event.pointerId || 'mouse';
                const drag = activePointers.get(pointerId);
                if (!drag) return;

                const { target, originLeft, originTop, startTime } = drag;
                const elapsed = Math.max(1, performance.now() - startTime);

                const currentLeft = parseFloat(target.style.left || 0);
                const currentTop = parseFloat(target.style.top || 0);
                const dx = currentLeft - originLeft;
                const dy = currentTop - originTop;

                const distance = Math.sqrt(dx * dx + dy * dy);
                const baseDuration = Math.min(1200, Math.max(400, distance * 8));
                const damping = 0.28 + Math.min(0.4, distance / 320);

                target.style.transition = `transform ${baseDuration}ms cubic-bezier(0.18, ${1 + damping}, 0.21, 1), left ${baseDuration}ms cubic-bezier(0.18, ${1 + damping}, 0.21, 1), top ${baseDuration}ms cubic-bezier(0.18, ${1 + damping}, 0.21, 1)`;

                const scale = parseFloat(target.dataset.scale || 1);
                target.style.transform = `scale(${scale})`;
                requestAnimationFrame(() => {
                    target.style.left = originLeft + 'px';
                    target.style.top = originTop + 'px';
                });

                activePointers.delete(pointerId);
                target.releasePointerCapture && target.releasePointerCapture(pointerId);
            }

            field.addEventListener('pointerdown', (event) => {
                const target = event.target.closest('.emoji');
                if (!target) return;
                initiateDrag(event, target);
            });

            field.addEventListener('pointermove', updateDrag);
            field.addEventListener('pointerup', endDrag);
            field.addEventListener('pointercancel', endDrag);
        })();
    </script>
</body>
</html>


